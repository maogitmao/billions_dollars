# 数据源优化计划

## 当前问题

### 现有数据源状态
1. **新浪财经** - ✅ 正常可用（需要Referer头）
2. **东方财富** - ✅ 正常可用（稳定）
3. **腾讯财经** - ✅ 正常可用（稳定）
4. **网易财经** - ❌ API已下线（DNS解析失败，502错误）

### 主要问题
- ~~免费接口随时可能被封禁~~ 已解决
- ~~连接不稳定，影响用户体验~~ 已改善
- 数据更新频率受限
- 需要长期监控接口稳定性

---

## 解决方案

### 方案1：使用本地同花顺数据（推荐）⭐

**优势**：
- ✅ 数据最准确、最及时
- ✅ 不依赖网络接口
- ✅ 稳定可靠
- ✅ 已安装同花顺Linux版

**实现方式**：
1. 读取同花顺的本地数据文件
2. 监听同花顺的数据更新
3. 通过进程间通信获取数据

**技术路径**：
```python
# 方案A：读取同花顺缓存文件
- 位置：~/.ths/data/ 或 /opt/ths/data/
- 格式：可能是二进制或加密格式
- 需要：逆向工程分析数据格式

# 方案B：通过同花顺API
- 查看同花顺是否提供本地API
- 可能需要付费或申请权限

# 方案C：内存读取
- 使用ptrace读取同花顺进程内存
- 技术难度较高
```

**开发优先级**：🔥 高

---

### 方案2：付费数据接口

**可选服务商**：

#### A. 聚宽数据（JoinQuant）
- 价格：免费额度 + 付费套餐
- 特点：专业量化数据，API稳定
- 网址：https://www.joinquant.com/

#### B. Tushare Pro
- 价格：积分制 + 付费
- 特点：数据全面，社区活跃
- 网址：https://tushare.pro/

#### C. 东方财富Choice
- 价格：专业版较贵
- 特点：数据最全，机构级
- 网址：http://choice.eastmoney.com/

#### D. Wind万得
- 价格：机构级，价格昂贵
- 特点：金融行业标准
- 适合：机构用户

**开发优先级**：🔶 中

---

### 方案3：自建数据爬虫

**实现方式**：
```python
# 1. 使用Selenium模拟浏览器
from selenium import webdriver
# 优点：可以绕过反爬
# 缺点：资源消耗大，速度慢

# 2. 使用代理池
# 优点：避免IP被封
# 缺点：需要维护代理池

# 3. 分布式爬虫
# 优点：提高效率
# 缺点：架构复杂
```

**法律风险**：⚠️ 需注意版权和服务条款

**开发优先级**：🔷 低

---

### 方案4：WebSocket实时数据流

**可用服务**：
- 雪球网 WebSocket
- 富途牛牛 OpenAPI
- 老虎证券 OpenAPI

**优势**：
- 实时推送，延迟低
- 数据稳定

**劣势**：
- 需要账号认证
- 可能有使用限制

**开发优先级**：🔶 中

---

### 方案5：混合方案（当前采用）

**策略**：
```python
优先级1: 腾讯财经（当前可用）
优先级2: 网易财经（备用）
优先级3: 其他免费接口
优先级4: 降级到缓存数据
```

**优化方向**：
1. 增加更多备用数据源
2. 实现智能切换机制
3. 添加数据缓存和离线模式
4. 监控接口可用性

**开发优先级**：✅ 已实现，持续优化

---

## 推荐实施路线

### 短期（1-2周）
1. ✅ 优化现有多数据源切换机制
2. ⏳ 添加数据缓存，减少请求频率
3. ⏳ 实现离线模式（使用历史缓存数据）
4. ⏳ 添加接口健康检查

### 中期（1-2月）
1. ⏳ 研究同花顺本地数据读取方案
2. ⏳ 评估付费数据接口（Tushare Pro）
3. ⏳ 实现WebSocket实时数据流
4. ⏳ 开发数据质量监控系统

### 长期（3-6月）
1. ⏳ 完全迁移到稳定数据源
2. ⏳ 建立自己的数据存储系统
3. ⏳ 实现数据回测功能
4. ⏳ 提供数据API给其他模块

---

## 技术实现建议

### 1. 数据缓存层
```python
# data/storage/cache_manager.py
class DataCache:
    def __init__(self):
        self.quote_cache = {}  # 实时行情缓存
        self.kline_cache = {}  # K线数据缓存
        self.expire_time = 60  # 缓存过期时间
    
    def get(self, key):
        # 从缓存获取数据
        pass
    
    def set(self, key, value, expire=None):
        # 设置缓存
        pass
```

### 2. 数据源管理器
```python
# data/fetchers/source_manager.py
class DataSourceManager:
    def __init__(self):
        self.sources = [
            TencentFetcher(),
            NeteaseFetcher(),
            # ... 更多数据源
        ]
    
    def get_quote(self, stock_code):
        # 自动切换数据源
        for source in self.sources:
            try:
                data = source.fetch(stock_code)
                if data:
                    return data
            except:
                continue
        return None
```

### 3. 健康检查
```python
# monitor/health_checker.py
class HealthChecker:
    def check_source(self, source):
        # 检查数据源是否可用
        pass
    
    def get_best_source(self):
        # 返回最佳数据源
        pass
```

---

## 成本估算

### 免费方案
- 成本：0元
- 风险：高（随时可能失效）
- 稳定性：低

### Tushare Pro
- 成本：0-2000元/年
- 风险：低
- 稳定性：高

### 同花顺本地数据
- 成本：0元（已有同花顺）
- 风险：中（需要逆向工程）
- 稳定性：高

### 专业数据服务
- 成本：5000-50000元/年
- 风险：极低
- 稳定性：极高

---

## 决策建议

### 个人用户
1. 优先尝试读取同花顺本地数据
2. 备用方案：Tushare Pro（性价比高）
3. 继续优化现有免费接口

### 商业用户
1. 直接使用专业数据服务
2. 建立自己的数据存储系统
3. 考虑多数据源验证

---

## 下一步行动

### 立即执行
- [ ] 添加数据缓存机制
- [ ] 实现离线模式
- [ ] 添加接口健康检查

### 近期研究
- [ ] 调研同花顺本地数据格式
- [ ] 注册Tushare Pro账号测试
- [ ] 评估WebSocket方案

### 长期规划
- [ ] 设计数据存储架构
- [ ] 开发数据质量监控
- [ ] 建立数据备份机制

---

**最后更新**: 2026-01-28
**负责人**: mao
**优先级**: 🔥 高
