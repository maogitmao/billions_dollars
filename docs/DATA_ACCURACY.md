# 数据准确性保证

## 问题背景

用户反馈：AI分析时出现不准确的信息，如未来日期、不相关的概念等。

## 根本原因

1. **新闻筛选不严格**：获取了大量不相关的通用新闻
2. **摘要质量差**：HTML标签未清理，内容混乱
3. **AI误读数据**：基于不准确的数据进行分析

## 解决方案

### 1. 严格的新闻筛选

**筛选规则（按优先级）：**

1. **最相关**：标题包含股票代码（如"600101"）
2. **相关**：标题包含股票名称（如"明星电力"）
3. **可能相关**：内容包含股票代码，但排除通用列表
4. **不相关**：通用新闻列表（如"60家公司业绩快报"）

**代码实现：**
```python
# 1. 标题包含股票代码（最相关）
if stock_code in title_clean:
    is_relevant = True
# 2. 标题包含股票名称（相关）
elif stock_name in title_clean:
    is_relevant = True
# 3. 内容包含股票代码（可能相关）
elif stock_code in content_clean:
    # 但排除通用列表类新闻
    if not ('家公司' in title_clean and len(title_clean) < 30):
        is_relevant = True
```

### 2. 智能摘要生成

**摘要生成规则：**

1. **优先提取相关句子**：包含股票代码或名称的句子
2. **清理HTML标签**：移除所有`<em>`、`<strong>`等标签
3. **清理格式**：移除多余空格、换行
4. **长度控制**：限制在200字以内

**代码实现：**
```python
# 提取包含股票代码或名称的句子
sentences = re.split(r'[。！？]', content_clean)
relevant_sentences = []

for sentence in sentences:
    if stock_code in sentence or stock_name in sentence:
        relevant_sentences.append(sentence.strip())
        if len('。'.join(relevant_sentences)) > 150:
            break

if relevant_sentences:
    summary = '。'.join(relevant_sentences)[:200]
```

### 3. 公告摘要优化

**智能关键词映射：**

根据公告标题关键词，生成准确的摘要：

| 关键词 | 摘要 |
|--------|------|
| 业绩、财报 | 公司发布业绩相关公告，涉及财务数据和经营情况 |
| 分红、派息 | 公司发布分红派息方案，涉及股东利益分配 |
| 重组、并购 | 公司发布重大资产重组公告，涉及资产收购或出售 |
| 增持、减持 | 股东增减持公司股份，需关注原因和规模 |
| ... | ... |

**代码实现：**
```python
def _generate_announcement_summary(self, title, ann_type):
    """智能生成公告摘要"""
    keywords_map = {
        '业绩': '公司发布业绩相关公告，涉及财务数据和经营情况',
        '分红': '公司发布分红派息方案，涉及股东利益分配',
        # ... 更多关键词
    }
    
    for keyword, summary in keywords_map.items():
        if keyword in title:
            return summary
    
    return f'{ann_type}类公告，详见公告全文'
```

### 4. 数据验证

**验证规则：**

1. **日期验证**：确保日期不超过当前日期
2. **内容验证**：确保内容与股票相关
3. **格式验证**：确保数据格式正确

### 5. AI提示词优化

**系统提示词强调：**

```python
STOCK_ANALYSIS_PROMPT = """你是一个专业的股票分析AI助手。

【重要规则】
1. 用户提供的数据是实时行情数据，来自程序的实时获取
2. 必须基于用户提供的实时数据进行分析
3. 不要使用你训练数据中的过时信息
4. 如果用户提供了具体数据，就用这些数据，不要说"我无法访问实时数据"
5. 只分析提供的数据，不要编造或推测不存在的信息
6. 如果数据不足，明确说明"数据不足"，不要猜测
"""
```

## 测试验证

### 测试用例1：600101明星电力

**改进前：**
- 获取15条新闻，大部分是"60家公司业绩快报"等通用列表
- 摘要包含HTML标签和无关数据
- AI分析出现"小金属概念"等不相关信息

**改进后：**
- 只获取1-5条真正相关的新闻
- 摘要清晰准确，只包含相关内容
- AI基于准确数据进行分析

### 测试用例2：600519贵州茅台

**改进前：**
- 新闻混杂，包含大量行业新闻
- 摘要质量参差不齐

**改进后：**
- 只获取茅台相关新闻
- 摘要准确反映新闻内容

## 质量保证措施

### 1. 数据源选择

- **优先级1**：官方公告（最准确）
- **优先级2**：专业财经媒体（较准确）
- **优先级3**：通用新闻（需筛选）

### 2. 数据清洗

- 移除HTML标签
- 清理格式问题
- 验证数据完整性

### 3. 相关性判断

- 标题相关性 > 内容相关性
- 专属新闻 > 通用新闻
- 近期新闻 > 历史新闻

### 4. 用户提示

当数据不足或质量不高时，明确告知用户：

```
系统提示：当前仅获取到1条与明星电力(600101)直接相关的新闻。
这是正常现象，说明该股票近期新闻报道较少。
建议关注公告信息获取更多公司动态。
```

## 持续改进

### 短期计划

- [x] 严格新闻筛选
- [x] 智能摘要生成
- [x] 公告关键词映射
- [ ] 添加数据验证
- [ ] 优化AI提示词

### 中期计划

- [ ] 多数据源交叉验证
- [ ] 数据质量评分
- [ ] 用户反馈机制
- [ ] 自动纠错功能

### 长期计划

- [ ] 机器学习筛选
- [ ] 自然语言理解
- [ ] 智能推荐
- [ ] 个性化定制

## 免责声明

⚠️ **重要提示**：

1. 所有数据来自公开渠道，尽力保证准确性
2. 但不保证100%准确，可能存在延迟或错误
3. 仅供参考，不构成投资建议
4. 投资有风险，入市需谨慎
5. 请以官方公告和实际交易为准

## 用户建议

1. **交叉验证**：结合多个数据源验证信息
2. **查看原文**：重要信息查看公告原文
3. **理性判断**：不要完全依赖AI分析
4. **及时反馈**：发现问题及时反馈

## 反馈渠道

如果发现数据不准确，请反馈：

1. 具体股票代码
2. 不准确的内容
3. 正确的信息来源
4. 截图或日志

我们会及时改进！
