# 分时图优化说明

## 优化内容

### 1. 数据密度提升
**问题**：原来每5分钟一个数据点，全天只有约50个点，曲线不够平滑
**解决**：
- 模拟数据改为每1分钟一个点，全天约240个点
- 真实数据保持接口返回的原始密度（通常也是分钟级）

### 2. 曲线平滑处理
**问题**：直接连接稀疏数据点，视觉上有明显折线感
**解决**：
- 使用scipy的三次样条插值（`make_interp_spline`）
- 在原始数据点之间生成10倍密度的插值点
- 使曲线更加平滑自然，接近真实交易软件的效果

### 3. 绘图性能优化
**问题**：每次刷新都完全重绘，造成卡顿
**解决**：
- 使用`antialiased=True`启用抗锯齿，提升视觉质量
- 使用`draw_idle()`延迟绘制，避免频繁刷新
- 快速更新模式（`fast_update=True`）用于自动刷新

### 4. 视觉细节优化
**改进项**：
- 线条宽度：价格线2px，均价线1.5px，更清晰
- 透明度调整：填充区域降低到8%，避免遮挡
- 网格优化：更细的网格线（0.5px），透明度25%
- 颜色优化：均价线使用橙色（#FF8C00）更醒目
- 自动Y轴范围：根据数据动态调整，留5%边距

### 5. 依赖更新
**新增**：
- `scipy>=1.10.0` - 用于数据平滑插值

## 使用方法

### 安装依赖
```bash
pip install scipy>=1.10.0
# 或者
pip install -r requirements.txt
```

### 效果对比

**优化前**：
- 数据点：~50个（5分钟间隔）
- 曲线：折线明显，不够平滑
- 刷新：有明显卡顿感

**优化后**：
- 数据点：~240个（1分钟间隔）
- 插值点：~2400个（10倍密度）
- 曲线：平滑流畅，接近专业软件
- 刷新：使用延迟绘制，更流畅

## 技术细节

### 样条插值原理
```python
from scipy.interpolate import make_interp_spline

# 原始数据点
x_range = np.arange(len(df))
prices = df['price'].values

# 生成10倍密度的平滑曲线
x_smooth = np.linspace(x_range.min(), x_range.max(), len(x_range) * 10)
spl = make_interp_spline(x_range, prices, k=3)  # k=3表示三次样条
prices_smooth = spl(x_smooth)
```

### 性能优化技巧
1. **缓存机制**：已加载的分时图缓存在内存中
2. **延迟绘制**：使用`draw_idle()`而不是`draw()`
3. **条件刷新**：只在交易时段自动刷新
4. **静默模式**：自动刷新时不输出日志，减少UI更新

## 注意事项

1. **插值限制**：至少需要4个数据点才能进行三次样条插值
2. **内存占用**：插值会增加数据点数量，但影响很小（KB级别）
3. **计算开销**：插值计算很快（毫秒级），不会影响性能
4. **真实数据**：东方财富接口返回的数据本身就比较密集，插值效果更好

## 后续优化方向

1. **实时数据流**：考虑使用WebSocket获取实时tick数据
2. **动画效果**：新数据点添加时使用平滑过渡动画
3. **成交量图**：在分时图下方添加成交量柱状图
4. **多股对比**：支持多只股票分时图叠加对比
5. **技术指标**：添加分时MACD、RSI等指标

## 测试建议

1. 选择一只股票查看分时图
2. 观察曲线是否平滑流畅
3. 在交易时段测试自动刷新（3秒间隔）
4. 快速切换不同股票，检查是否有卡顿
5. 对比优化前后的视觉效果

## 问题排查

### 如果出现导入错误
```bash
# 确保scipy已安装
pip install scipy

# 如果还有问题，尝试升级
pip install --upgrade scipy
```

### 如果曲线不平滑
- 检查数据点数量（至少需要4个点）
- 查看日志中是否有插值失败的提示
- 确认scipy版本 >= 1.10.0

### 如果刷新卡顿
- 检查是否在交易时段（只在交易时段自动刷新）
- 查看系统资源占用
- 尝试关闭其他占用资源的程序
